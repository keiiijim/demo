<body>
  <!-- 高さを確保する透明のダミー領域 -->
  <div id="ad-back" style="height:0;"></div>

  <!-- オーバーレイ用の広告コンテナ -->
  <div id="apv-container" style="position:fixed;top:0;left:0;width:100%;z-index:9999;"></div>
  <div id="apvad-adg-locationidsample"></div>

  <div class="dummy">ダミーコンテンツ①</div>
  <div class="dummy">ダミーコンテンツ②</div>
  <div class="dummy">ダミーコンテンツ③</div>
  <div class="dummy">ダミーコンテンツ④</div>

  <script>
    // 高さを ad-back に反映
    function adjustAdBackHeight() {
      const adBack = document.getElementById("ad-back");
      const adContainer = document.getElementById("apv-container");

      const h = adContainer.offsetHeight;
      if (h > 0) {
        adBack.style.height = h + "px";
      } else {
        requestAnimationFrame(adjustAdBackHeight);
      }
    }

    // 広告を閉じる共通処理
    function closeAd() {
      const adContainer = document.getElementById("apv-container");
      const adBack = document.getElementById("ad-back");

      adContainer.style.transition = "opacity 0.6s ease";
      adContainer.style.opacity = "0";

      setTimeout(() => {
        adContainer.style.display = "none";
        adBack.style.height = "0px";
      }, 650);
    }

    // 監視：クローズボタンが出たら hook
    function watchCloseBtn() {
      const btn = document.querySelector(".apv-btn-close");
      if (btn) {
        btn.addEventListener("click", closeAd, { once: true });
        console.log("[hook] クローズボタン監視開始");
      } else {
        requestAnimationFrame(watchCloseBtn);
      }
    }

    // 監視：動画終了を検知して自動クローズ
    function watchVideoComplete() {
      const iframe = document.querySelector("iframe.apv-wrapper");
      if (!iframe) {
        requestAnimationFrame(watchVideoComplete);
        return;
      }

      // iframe内イベントまでは直接取れないので、complete用のbeaconをhookする例
      const beaconChecker = setInterval(() => {
        // Tracking beaconが飛んだタイミングで検知することを想定
        // （ここは実運用で network log hook か、SDK APIがあればそれを利用）
        if (window.__adComplete) {
          clearInterval(beaconChecker);
          closeAd();
        }
      }, 500);
    }

    window.addEventListener("load", () => {
      adjustAdBackHeight();
      watchCloseBtn();
      watchVideoComplete();
    });

    window.addEventListener("resize", adjustAdBackHeight);
  </script>
</body>
